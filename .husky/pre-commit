#!/bin/sh
set -e

# Get list of staged files for processing
STAGED_FILES=$(git diff --name-only --cached)

# Sort JSON locale files alphabetically
pnpm exec sort-json public/locales/*.json

# Run linting and formatting on staged files
pnpm exec lint-staged

# Run unit tests for staged JS files
if [ -n "$STAGED_FILES" ]; then
  STAGED_JS=$(echo "$STAGED_FILES" | grep -E '\.js$|\.jsx$' || true)
  if [ -n "$STAGED_JS" ]; then
    if pnpm exec jest --version > /dev/null 2>&1; then
      pnpm exec jest --findRelatedTests $STAGED_JS --passWithNoTests
    fi
  fi
fi

# Re-add files that were modified by linters
for file in $STAGED_FILES; do
  if [ -f "$file" ] && ! git diff --quiet "$file"; then
    git add "$file"
  fi
  if [ ! -f "$file" ] && git ls-files --error-unmatch "$file" > /dev/null 2>&1; then
    git rm --cached "$file"
  fi
  if [ -L "$file" ] && ! git diff --quiet "$file"; then
    git add "$file"
  fi
done
