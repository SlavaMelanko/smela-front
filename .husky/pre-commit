echo "Running pre-commit hook..."

set -e

STAGED_FILES=$(git diff --name-only --cached)

SORT_JSON_PATH="public/locales/*.json"

echo "Sorting locales in $SORT_JSON_PATH..."

npx sort-json $SORT_JSON_PATH

echo "JSON files checkedâœ…"

echo "Running lint-staged..."

npx lint-staged

echo "Lint staged completedâœ…"

echo "Checking for staged styles..."
STAGED_STYLES=$(echo "$STAGED_FILES" | grep -E '\.scss$|\.css$' || true)

if [ -n "$STAGED_STYLES" ]; then
  echo "Affected styles files: $STAGED_STYLES"
  echo "Running styles linting..."
  npm run lint:styles:fix
  echo "Styles linting completedâœ…"
else
  echo "No styles to lint. Stylelint skipped!"
fi

echo "Testing committed files..."
STAGED_JS=$(echo "$STAGED_FILES" | grep -E '\.js$|\.jsx$' || true)

if [ -n "$STAGED_JS" ]; then
  if ! npx --no-install jest --version > /dev/null 2>&1; then
    echo "Jest is not installed. Skipping unit tests."
  else
    echo "Affected JS files: $STAGED_JS"
    echo "Running related unit tests..."
    npx jest --findRelatedTests $STAGED_JS --passWithNoTests
  fi
else
  echo "No JS files to test. Unit tests skipped!"
fi

for file in $STAGED_FILES; do
  if [ -f "$file" ] && ! git diff --quiet "$file"; then
    git add "$file"
  fi
  if [ ! -f "$file" ] && git ls-files --error-unmatch "$file" > /dev/null 2>&1; then
    git rm --cached "$file"
  fi
  if [ -L "$file" ] && ! git diff --quiet "$file"; then
    git add "$file"
  fi
done

echo "May the force be with you!ðŸš€"
