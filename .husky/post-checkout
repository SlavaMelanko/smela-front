#!/bin/sh
set -e

# Get the arguments: previous HEAD, new HEAD, and branch flag
PREV_HEAD=$1
NEW_HEAD=$2
BRANCH_FLAG=$3

# Skip during initial clone (when previous HEAD is all zeros)
if [ "$PREV_HEAD" = "0000000000000000000000000000000000000000" ]; then
  exit 0
fi

# Skip if not a branch checkout
if [ "$BRANCH_FLAG" != "1" ]; then
  exit 0
fi

# Check if lockfile changed between commits
if git diff --name-only "$PREV_HEAD" "$NEW_HEAD" | grep -q "^pnpm-lock\.yaml$"; then
  if ! pnpm install; then
    echo "Warning: Failed to install dependencies, please run 'pnpm install' manually"
  fi
fi
