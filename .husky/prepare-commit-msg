#!/bin/sh
set -e

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Skip for merge commits and template sources
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "template" ]; then
  exit 0
fi

# Get list of staged files
STAGED_FILES=$(git diff --name-only --cached)

# If no staged files (shouldn't happen), exit
if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Check for Docker CI-related changes
HAS_DOCKER_CI_CHANGES=$(echo "$STAGED_FILES" | grep -E "^(Dockerfile\.ci|package(-lock)?\.json|\.github/workflows/docker-ci\.yml)$" || true)

# Add package emoji if any Docker CI files changed
if [ -n "$HAS_DOCKER_CI_CHANGES" ]; then
  CURRENT_MSG=$(cat "$COMMIT_MSG_FILE")

  # Check if emoji already exists at start
  if ! echo "$CURRENT_MSG" | grep -qE "^ðŸ“¦ "; then
    echo "ðŸ“¦ ${CURRENT_MSG}" > "$COMMIT_MSG_FILE"
  fi
fi
